<!DOCTYPE html>

<html>
<head>
  <title>HtmlGenerator.php</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="HtmlGenerator.html">
                HtmlGenerator.php
              </a>
            
              
              <a class="source" href="index.html">
                index.php
              </a>
            
              
              <a class="source" href="suggest.html">
                suggest.php
              </a>
            
              
              <a class="source" href="tracking.html">
                tracking.php
              </a>
            
              
              <a class="source" href="initialization.html">
                initialization.php
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>HtmlGenerator.php</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-preprocessor">&lt;?php</span>
<span class="hljs-keyword">namespace</span> <span class="hljs-title">FACTFinderDemo</span>\<span class="hljs-title">Helper</span>;

<span class="hljs-keyword">use</span> <span class="hljs-title">FACTFinder</span>\<span class="hljs-title">Loader</span> <span class="hljs-title">as</span> <span class="hljs-title">FF</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HtmlGenerator</span>
{</span>
    <span class="hljs-keyword">private</span> <span class="hljs-variable">$searchAdapter</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-variable">$tagCloudAdapter</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-variable">$requestParser</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-variable">$templateDir</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-variable">$pageContentEncoding</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-variable">$log</span>;

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">(
        <span class="hljs-variable">$loggerClass</span>,
        <span class="hljs-variable">$configuration</span>,
        <span class="hljs-variable">$requestParser</span>,
        <span class="hljs-variable">$searchAdapter</span>,
        <span class="hljs-variable">$tagCloudAdapter</span>,
        <span class="hljs-variable">$templateDir</span>
    )</span> {</span>
        <span class="hljs-variable">$this</span>-&gt;log = <span class="hljs-variable">$loggerClass</span>::getLogger(<span class="hljs-keyword">__CLASS__</span>);

        <span class="hljs-variable">$this</span>-&gt;pageContentEncoding = <span class="hljs-variable">$configuration</span>-&gt;getPageContentEncoding();

        <span class="hljs-variable">$this</span>-&gt;requestParser       = <span class="hljs-variable">$requestParser</span>;

        <span class="hljs-variable">$this</span>-&gt;searchAdapter       = <span class="hljs-variable">$searchAdapter</span>;
        <span class="hljs-variable">$this</span>-&gt;tagCloudAdapter     = <span class="hljs-variable">$tagCloudAdapter</span>;

        <span class="hljs-variable">$this</span>-&gt;templateDir         = <span class="hljs-variable">$templateDir</span>;
    }

    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getTemplate</span><span class="hljs-params">(<span class="hljs-variable">$name</span>)</span> {</span>
        <span class="hljs-keyword">return</span> <span class="hljs-variable">$this</span>-&gt;templateDir.DS.<span class="hljs-variable">$name</span>.<span class="hljs-string">'.phtml'</span>;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getHtmlCode</span><span class="hljs-params">()</span>
    {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <h2 id="rendering-the-page">Rendering the page</h2>

            </div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Activate the output buffer, so that we don’t render immediately to
the response.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        ob_start();</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>We will now fill a bunch of variables which we can use in the
templates later on. Most of these variables will be the results from
our requests to the FACT-Finder server (obtained by the adapters).</p>

            </div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>We’ll need the encoding for rendering the <code>Content-Type</code> meta-tag.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-variable">$encoding</span> = <span class="hljs-variable">$this</span>-&gt;pageContentEncoding;</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>This object provides convenient access to several important query
parameters relating to actual search.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-variable">$searchParameters</span> = FF::getInstance(
            <span class="hljs-string">'Data\SearchParameters'</span>,
            <span class="hljs-variable">$this</span>-&gt;requestParser-&gt;getRequestParameters()
        );</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>We’ll need the target for the action of the search box form.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-variable">$target</span> = <span class="hljs-variable">$this</span>-&gt;requestParser-&gt;getRequestTarget();

        <span class="hljs-variable">$trackingEvents</span> = <span class="hljs-keyword">array</span>();</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Get or start a session. This is needed for the tracking. If it’s
a new session, mark that event for tracking.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-variable">$sid</span> = session_id();
        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$sid</span> === <span class="hljs-string">''</span>) {
            session_start();
            <span class="hljs-variable">$sid</span> = session_id();
            <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">'started'</span>])) {
                <span class="hljs-variable">$trackingEvents</span>[<span class="hljs-string">'sessionStart'</span>] = <span class="hljs-keyword">array</span>();
                <span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">'started'</span>] = <span class="hljs-keyword">true</span>;
            }
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>The library contains a few “enums” (of course, PHP does not have
enums, but we’ve tried to work around them as closely as possible).
Their values can be obtained from static methods, so we’ll need the
enum’s class name.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-variable">$searchStatusEnum</span> = FF::getClassName(<span class="hljs-string">'Data\SearchStatus'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>We slightly abuse exception handling for flow control here. If all
goes well, the entire page will be rendered in the <code>try</code> block.
However, if the search fails, or we need a redirect, or there is
some actual (unexpected) exception, we’ll handle that in the
appropriate <code>catch</code> blocks.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">try</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Don’t even attempt a search if there is no search query.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
            <span class="hljs-comment">/* TODO: Do this inside the Search adapter? */</span>
            <span class="hljs-keyword">if</span> (!<span class="hljs-variable">$searchParameters</span>-&gt;getQuery()
                &amp;&amp; !<span class="hljs-variable">$searchParameters</span>-&gt;isNavigationEnabled()
            ) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> NoQueryException();
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Get the campaigns first, because they might contain a redirect.
If so, exit the <code>try</code> block with an appropriate exception.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-variable">$campaigns</span> = <span class="hljs-variable">$this</span>-&gt;searchAdapter-&gt;getCampaigns();
            <span class="hljs-keyword">if</span> (<span class="hljs-variable">$campaigns</span>-&gt;hasRedirect()) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RedirectException(<span class="hljs-variable">$campaigns</span>-&gt;getRedirectUrl());
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Now we’ll save all the data from our adapters into corresponding
variables. The templates will then use these to render the page.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-variable">$status</span>                 = <span class="hljs-variable">$this</span>-&gt;searchAdapter-&gt;getStatus();
            <span class="hljs-comment">/*$isArticleNumberSearch  = $this-&gt;searchAdapter-&gt;isArticleNumberSearch();*/</span>
            <span class="hljs-variable">$isSearchTimedOut</span>       = <span class="hljs-variable">$this</span>-&gt;searchAdapter-&gt;isSearchTimedOut();

            <span class="hljs-variable">$productsPerPageOptions</span> = <span class="hljs-variable">$this</span>-&gt;searchAdapter-&gt;getResultsPerPageOptions();
            <span class="hljs-variable">$breadCrumbTrail</span>        = <span class="hljs-variable">$this</span>-&gt;searchAdapter-&gt;getBreadCrumbTrail();
            <span class="hljs-variable">$singleWordSearch</span>       = <span class="hljs-variable">$this</span>-&gt;searchAdapter-&gt;getSingleWordSearch();
            <span class="hljs-variable">$paging</span>                 = <span class="hljs-variable">$this</span>-&gt;searchAdapter-&gt;getPaging();
            <span class="hljs-variable">$sorting</span>                = <span class="hljs-variable">$this</span>-&gt;searchAdapter-&gt;getSorting();
            <span class="hljs-variable">$asn</span>                    = <span class="hljs-variable">$this</span>-&gt;searchAdapter-&gt;getAfterSearchNavigation();
            <span class="hljs-variable">$result</span>                 = <span class="hljs-variable">$this</span>-&gt;searchAdapter-&gt;getResult();

            <span class="hljs-variable">$tagCloud</span>               = <span class="hljs-variable">$this</span>-&gt;tagCloudAdapter-&gt;getTagCloud();

            <span class="hljs-comment">/*$util = FF::getInstance('util', $this-&gt;searchAdapter);*/</span></pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Depending on the status of search, render the appropriate
template. There are three different “root” templates (i.e.
templates, which include the entire <code>&lt;html&gt;</code>-tree):</p>
<ul>
<li><code>index.phtml</code> is for actual search results.</li>
<li><code>noMatch.phtml</code> is for successful searches that did not yield
any results.</li>
<li><code>error.phtml</code> is for all kinds of problems which may have
occurred.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">switch</span> (<span class="hljs-variable">$status</span>) {
                <span class="hljs-keyword">case</span> <span class="hljs-variable">$searchStatusEnum</span>::RecordsFound():
                    <span class="hljs-variable">$trackingEvents</span>[<span class="hljs-string">'display'</span>] = <span class="hljs-keyword">array</span>();
                    <span class="hljs-keyword">include</span> <span class="hljs-variable">$this</span>-&gt;getTemplate(<span class="hljs-string">'index'</span>);
                    <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">case</span> <span class="hljs-variable">$searchStatusEnum</span>::EmptyResult():
                    <span class="hljs-variable">$message</span> = <span class="hljs-string">'No result for &lt;strong&gt;"'</span>
                             . htmlspecialchars(<span class="hljs-variable">$searchParameters</span>-&gt;getQuery())
                             . <span class="hljs-string">'"&lt;/strong&gt;'</span>;
                    <span class="hljs-keyword">include</span> <span class="hljs-variable">$this</span>-&gt;getTemplate(<span class="hljs-string">'noMatch'</span>);
                    <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">case</span> <span class="hljs-variable">$searchStatusEnum</span>::NoResult():
                    <span class="hljs-variable">$error</span> = <span class="hljs-string">'No result - an error occurred...'</span>;
                    <span class="hljs-keyword">include</span> <span class="hljs-variable">$this</span>-&gt;getTemplate(<span class="hljs-string">'error'</span>);
                    <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">default</span>:
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-keyword">Exception</span>(<span class="hljs-string">'No result (unknown status)'</span>);
            }
        } <span class="hljs-keyword">catch</span> (\<span class="hljs-keyword">Exception</span> <span class="hljs-variable">$e</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>This is some code duplication from the above <code>switch</code> statement
and handles different exceptions by doing a redirect or rendering
the appropriate template.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> (<span class="hljs-variable">$e</span> <span class="hljs-keyword">instanceof</span> RedirectException) {
                <span class="hljs-variable">$this</span>-&gt;doRedirect(<span class="hljs-variable">$e</span>-&gt;getMessage());
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-variable">$e</span> <span class="hljs-keyword">instanceof</span> NoQueryException) {
                <span class="hljs-variable">$message</span> = <span class="hljs-string">'Please enter a search query'</span>;
                <span class="hljs-keyword">include</span> <span class="hljs-variable">$this</span>-&gt;getTemplate(<span class="hljs-string">'noMatch'</span>);
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-variable">$error</span> = <span class="hljs-variable">$e</span>-&gt;getMessage();
                <span class="hljs-keyword">include</span> <span class="hljs-variable">$this</span>-&gt;getTemplate(<span class="hljs-string">'error'</span>);
            }
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Finally, clean the buffer and return its contents as a string. This
string will contain the entire HTML page.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">return</span> ob_get_clean();
    }

    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">doRedirect</span><span class="hljs-params">(<span class="hljs-variable">$url</span>)</span>
    {</span>
        <span class="hljs-keyword">if</span> (!headers_sent()) {
                header(<span class="hljs-string">'Location: '</span>.<span class="hljs-variable">$url</span>);
        } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">echo</span> <span class="hljs-string">'&lt;meta http-equiv="refresh" content="0; URL='</span>.<span class="hljs-variable">$url</span>.<span class="hljs-string">'"&gt; &lt;a href="'</span>.<span class="hljs-variable">$url</span>.<span class="hljs-string">'"&gt;&lt;/a&gt;'</span>;
        }
    }
}</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>Unfortunately, PHP does not support internal classes, so we define our own
Exception types here.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">NoQueryException</span> <span class="hljs-keyword">extends</span> \<span class="hljs-title">Exception</span>{</span>}
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RedirectException</span> <span class="hljs-keyword">extends</span> \<span class="hljs-title">Exception</span>{</span>}</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
